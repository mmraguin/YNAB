<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>tribe</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Syne:wght@700;800&family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700&family=DM+Mono:wght@400;500&display=swap');
:root {
  --bg:#0b0b0d;--surface:#141416;--surface2:#1e1e22;--surface3:#28282e;
  --border:#2a2a30;--border2:#363640;
  --accent:#2a9d9f;--accent-dim:rgba(42,157,159,0.10);--accent-border:rgba(42,157,159,0.25);
  --text:#ededf0;--text2:#9898a6;--muted:#60606e;
  --income:#4ade80;--income-dim:rgba(74,222,128,0.08);--income-border:rgba(74,222,128,0.20);
  --expense:#ff5c5c;--expense-dim:rgba(255,92,92,0.08);--expense-border:rgba(255,92,92,0.20);
  --danger:#e63946;--transfer:#b8a9e0;
  --warn:#c8922a;--warn-dim:rgba(200,146,42,0.08);--warn-border:rgba(200,146,42,0.25);
  --tab-h:60px;--safe-b:env(safe-area-inset-bottom,0px);
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html,body{height:100%;overflow:hidden}
body{font-family:'DM Sans',sans-serif;font-variant-numeric:tabular-nums;background:var(--bg);color:var(--text);display:flex;justify-content:center}
body::after{content:'';position:fixed;inset:0;z-index:9999;pointer-events:none;opacity:.025;
  background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.035'/%3E%3C/svg%3E")}
.app{width:100%;max-width:430px;height:100%;display:flex;flex-direction:column;overflow:hidden}
.hdr{flex-shrink:0;padding:13px 14px 11px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border);background:rgba(11,11,13,.95);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);z-index:10}
.wordmark{font-family:'Syne',sans-serif;font-size:20px;font-weight:800;letter-spacing:-.03em}
.wordmark em{color:var(--accent);font-style:normal}
.hdr-r{display:flex;gap:6px;align-items:center}
.mnav{display:flex;align-items:center;gap:2px;background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:4px 6px}
.marrow{background:none;border:none;color:var(--muted);cursor:pointer;font-size:16px;line-height:1;padding:0 4px;transition:color .15s}
.marrow:hover{color:var(--accent)}
.mlabel{font-family:'DM Mono',monospace;font-size:11px;font-weight:500;color:var(--text);min-width:68px;text-align:center;letter-spacing:.04em}
.hbtn{width:32px;height:32px;border-radius:10px;border:1px solid var(--border);background:var(--surface);color:var(--muted);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:14px;transition:all .15s;user-select:none}
.hbtn:active{transform:scale(.9);color:var(--accent)}
.hbtn.on{color:var(--warn);border-color:var(--warn-border);background:var(--warn-dim)}
.pw{flex:1;overflow:hidden;position:relative}
.pages{display:flex;width:500%;height:100%;transition:transform .32s cubic-bezier(.22,1,.36,1)}
.page{width:20%;height:100%;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;flex-shrink:0}
.page::-webkit-scrollbar{display:none}
.pi{padding:12px 12px 28px;display:flex;flex-direction:column;gap:10px}
.tabbar{flex-shrink:0;height:calc(var(--tab-h) + var(--safe-b));padding-bottom:var(--safe-b);border-top:1px solid var(--border);background:rgba(20,20,22,.92);backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);display:flex;z-index:10}
.tab{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px;cursor:pointer;color:var(--muted);padding-top:4px;transition:color .15s;user-select:none}
.tab:active{transform:scale(.88)}
.tab.active{color:var(--accent)}
.ti{width:20px;height:20px;position:relative}
.ti svg{width:100%;height:100%;stroke:currentColor;fill:none;stroke-width:1.75;stroke-linecap:round;stroke-linejoin:round}
.tlabel{font-size:9px;font-weight:600;letter-spacing:.01em}
.tbadge{position:absolute;top:-3px;right:-7px;background:var(--expense);color:#fff;font-family:'DM Mono',monospace;font-size:8px;font-weight:500;border-radius:10px;padding:1px 4px;min-width:14px;text-align:center}
.sc{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:48px 20px;display:flex;flex-direction:column;align-items:center;gap:14px}
.pr{width:40px;height:40px;position:relative;display:flex;align-items:center;justify-content:center}
.pr::before,.pr::after{content:'';position:absolute;border:1.5px solid var(--accent);border-radius:50%;animation:pout 1.4s ease-out infinite}
.pr::after{animation-delay:.6s}
@keyframes pout{0%{width:10px;height:10px;opacity:1}100%{width:40px;height:40px;opacity:0}}
.pdot{width:8px;height:8px;border-radius:50%;background:var(--accent)}
.stext{font-size:13px;color:var(--text2);text-align:center;line-height:1.5}
.etitle{font-family:'Syne',sans-serif;font-size:15px;font-weight:700;color:var(--danger)}
.btn-retry{background:var(--danger);color:#fff;border:none;border-radius:10px;padding:10px 24px;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer}
.lbl{font-family:'DM Mono',monospace;font-size:10px;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);padding:2px 2px 0}
.hero{background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:18px 20px;position:relative;overflow:hidden;animation:fadeUp .2s cubic-bezier(.22,1,.36,1)}
.hglow{position:absolute;top:-60px;left:-40px;width:220px;height:220px;border-radius:50%;pointer-events:none}
.hglow.pos{background:radial-gradient(circle,rgba(74,222,128,.12) 0%,transparent 70%)}
.hglow.warn{background:radial-gradient(circle,rgba(200,146,42,.12) 0%,transparent 70%)}
.hglow.neg{background:radial-gradient(circle,rgba(255,92,92,.12) 0%,transparent 70%)}
.hi{position:relative;z-index:1}
.hmlbl{font-family:'DM Mono',monospace;font-size:10px;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);margin-bottom:5px}
.hamt{font-variant-numeric:tabular-nums;font-size:36px;font-weight:700;letter-spacing:-.025em;line-height:1}
.hamt.pos{color:var(--income)}.hamt.warn{color:var(--warn)}.hamt.neg{color:var(--expense)}
.hchip{display:inline-block;font-family:'DM Mono',monospace;font-size:9px;letter-spacing:.08em;text-transform:uppercase;padding:3px 8px;border-radius:20px;font-weight:500;margin-top:5px}
.hchip.pos{background:var(--income-dim);color:var(--income);border:1px solid var(--income-border)}
.hchip.warn{background:var(--warn-dim);color:var(--warn);border:1px solid var(--warn-border)}
.hchip.neg{background:var(--expense-dim);color:var(--expense);border:1px solid var(--expense-border)}
.hstats{display:grid;grid-template-columns:1fr 1fr 1fr;border-top:1px solid var(--border);padding-top:12px;margin-top:14px;position:relative;z-index:1}
.hs{text-align:center;padding:0 4px;border-right:1px solid var(--border)}.hs:last-child{border-right:none}
.hslbl{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:.08em;text-transform:uppercase;color:var(--muted);margin-bottom:3px}
.hsval{font-size:13px;font-weight:600;font-variant-numeric:tabular-nums}
.ic{color:var(--income)}.ec{color:var(--expense)}.nc{color:var(--text2)}.wc{color:var(--warn)}
.alert{border-radius:12px;padding:10px 14px;display:flex;justify-content:space-between;align-items:center;gap:10px;animation:fadeUp .2s cubic-bezier(.22,1,.36,1)}
.alert.e{background:var(--expense-dim);border:1px solid var(--expense-border)}
.atxt{font-size:12px;line-height:1.45}
.atxt strong{font-weight:600;color:var(--text);display:block;margin-bottom:1px}
.atxt span{color:var(--text2)}
.ax{background:none;border:none;color:var(--muted);cursor:pointer;font-size:18px;flex-shrink:0;padding:0 2px;line-height:1}
.pace{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:14px 16px}
.pace-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.pace-lbl{font-family:'DM Mono',monospace;font-size:10px;letter-spacing:.08em;text-transform:uppercase;color:var(--muted)}
.pchip{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:.06em;text-transform:uppercase;padding:3px 8px;border-radius:20px;font-weight:500}
.pchip.good{background:var(--income-dim);color:var(--income);border:1px solid var(--income-border)}
.pchip.warn{background:var(--warn-dim);color:var(--warn);border:1px solid var(--warn-border)}
.pchip.over{background:var(--expense-dim);color:var(--expense);border:1px solid var(--expense-border)}
.prow{display:flex;justify-content:space-between;align-items:center;margin-bottom:5px}
.prl{font-size:12px;color:var(--text2)}.prv{font-family:'DM Mono',monospace;font-size:11px;color:var(--text)}
.bt{height:4px;background:var(--surface3);border-radius:2px;overflow:hidden;margin-bottom:10px}
.bt.last{margin-bottom:0}
.bf{height:100%;border-radius:2px;transition:width .6s cubic-bezier(.22,1,.36,1)}
.bf.ic{background:var(--income)}.bf.ec{background:var(--expense)}.bf.wc{background:var(--warn)}.bf.ac{background:var(--accent)}
.grp{display:flex;flex-direction:column;gap:3px}
.grphdr{display:flex;justify-content:space-between;align-items:center;padding:10px 2px 4px;cursor:pointer;user-select:none}
.grphdr:active{opacity:.7}
.grptitle{font-family:'Syne',sans-serif;font-size:13px;font-weight:700;color:var(--text2);display:flex;align-items:center;gap:5px}
.grptog{font-size:10px;color:var(--muted);transition:transform .2s;line-height:1}
.grptog.coll{transform:rotate(-90deg)}
.grpav{font-size:13px;font-weight:700;font-variant-numeric:tabular-nums}
.grpav.pos{color:var(--income)}.grpav.neg{color:var(--expense)}.grpav.zero{color:var(--muted)}
.grpcats{display:flex;flex-direction:column;gap:3px;overflow:hidden;transition:max-height .28s cubic-bezier(.22,1,.36,1),opacity .2s}
.grpcats.coll{max-height:0!important;opacity:0;pointer-events:none}
.cat{background:var(--surface);border:1px solid var(--border);border-left:3px solid var(--surface3);border-radius:14px;overflow:hidden;cursor:pointer;transition:border-color .15s,background .15s;animation:fadeUp .2s cubic-bezier(.22,1,.36,1) both}
.cat:active{transform:scale(.985)}
.cat.ok{border-left-color:var(--income)}
.cat.warn{border-left-color:var(--warn);border-color:var(--warn-border);background:var(--warn-dim)}
.cat.over{border-left-color:var(--expense);border-color:var(--expense-border);background:var(--expense-dim)}
.cat.zero{border-left-color:var(--muted)}
.cattop{padding:11px 14px 8px;display:flex;justify-content:space-between;align-items:flex-start;gap:8px}
.catl{display:flex;flex-direction:column;gap:2px;flex:1;min-width:0}
.catname{font-size:14px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.catsub{font-family:'DM Mono',monospace;font-size:10px;color:var(--muted)}
.catr{display:flex;flex-direction:column;align-items:flex-end;gap:2px;flex-shrink:0}
.catav{font-size:15px;font-weight:700;font-variant-numeric:tabular-nums}
.catav.pos{color:var(--income)}.catav.neg{color:var(--expense)}.catav.zero{color:var(--muted)}
.catsp{font-family:'DM Mono',monospace;font-size:10px;color:var(--muted)}
.catbarwrap{padding:0 14px 10px;display:flex;flex-direction:column;gap:4px}
.catbarlbls{display:flex;justify-content:space-between;font-family:'DM Mono',monospace;font-size:9px;color:var(--muted)}
.catbartrack{height:5px;background:var(--surface3);border-radius:3px;overflow:hidden;position:relative}
.catbarassigned{position:absolute;top:0;left:0;height:100%;background:rgba(42,157,159,.22);border-radius:3px}
.catbaract{position:absolute;top:0;left:0;height:100%;border-radius:3px;transition:width .6s cubic-bezier(.22,1,.36,1)}
.catbaract.ok{background:var(--accent)}.catbaract.warn{background:var(--warn)}.catbaract.over{background:var(--expense)}
.det{max-height:0;overflow:hidden;transition:max-height .32s cubic-bezier(.22,1,.36,1);background:var(--surface2);border-top:1px solid var(--border)}
.det.open{max-height:750px}
.detin{padding:12px 14px;display:flex;flex-direction:column;gap:10px}
.detgrid{display:grid;grid-template-columns:1fr 1fr;gap:5px}
.dstat{background:var(--surface3);border-radius:10px;padding:9px 12px}
.dslbl{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:.08em;text-transform:uppercase;color:var(--muted);margin-bottom:3px}
.dsval{font-size:14px;font-weight:700;font-variant-numeric:tabular-nums}
.dsval.pos{color:var(--income)}.dsval.neg{color:var(--expense)}.dsval.n{color:var(--text2)}
.bvabarsec{display:flex;flex-direction:column;gap:4px;background:var(--surface3);border-radius:10px;padding:10px 12px}
.bvalblrow{display:flex;justify-content:space-between;align-items:center;margin-bottom:2px}
.bvalbl{font-family:'DM Mono',monospace;font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:.07em}
.bvaval{font-family:'DM Mono',monospace;font-size:10px;font-variant-numeric:tabular-nums;font-weight:600}
.bvatrack{height:8px;background:var(--surface);border-radius:4px;overflow:hidden;position:relative}
.bvaassigned{position:absolute;top:0;left:0;height:100%;background:rgba(42,157,159,.2);border-radius:4px}
.bvaact{position:absolute;top:0;left:0;height:100%;border-radius:4px}
.bvaact.ok{background:var(--accent)}.bvaact.warn{background:var(--warn)}.bvaact.over{background:var(--expense)}
.bvasubrow{display:flex;justify-content:space-between;margin-top:4px}
.bvasubl{font-family:'DM Mono',monospace;font-size:9px;color:var(--muted)}
.dettitle{font-family:'DM Mono',monospace;font-size:10px;letter-spacing:.08em;text-transform:uppercase;color:var(--muted)}
.dtxn{display:flex;align-items:flex-start;padding:8px 0;border-bottom:1px solid var(--border);gap:8px}
.dtxn:last-child{border-bottom:none}
.dtxnl{flex:1;display:flex;flex-direction:column;gap:2px;min-width:0}
.dtxnname{font-size:13px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.dtxnmemo{font-size:11px;color:var(--text2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-style:italic}
.dtxnmeta{font-family:'DM Mono',monospace;font-size:10px;color:var(--muted)}
.dtxnamt{font-size:13px;font-weight:600;font-variant-numeric:tabular-nums;flex-shrink:0}
.dtxnamt.e{color:var(--expense)}.dtxnamt.i{color:var(--income)}
.dtxnempty{font-size:12px;color:var(--muted);text-align:center;padding:12px 0}
.sw{position:relative}
.si{width:100%;background:var(--surface);border:1px solid var(--border);border-radius:10px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:14px;padding:10px 14px 10px 36px;outline:none;transition:border-color .15s}
.si:focus{border-color:var(--accent-border)}
.si::placeholder{color:var(--muted)}
.sico{position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--muted);font-size:14px;pointer-events:none}
.chips{display:flex;gap:6px;flex-wrap:wrap}
.chip{font-family:'DM Sans',sans-serif;font-size:12px;font-weight:500;padding:5px 12px;border-radius:20px;border:1px solid var(--border2);background:var(--surface);color:var(--text2);cursor:pointer;transition:all .15s;white-space:nowrap}
.chip:active{transform:scale(.94)}
.chip.active{background:var(--accent);border-color:var(--accent);color:#051010;font-weight:600}
.dg{display:flex;flex-direction:column}
.dghdr{display:flex;justify-content:space-between;align-items:center;padding:10px 2px 5px}
.dglbl{font-family:'DM Mono',monospace;font-size:11px;color:var(--text2);font-weight:500}
.dgtot{font-family:'DM Mono',monospace;font-size:11px;font-variant-numeric:tabular-nums}
.dgtot.neg{color:var(--expense)}.dgtot.pos{color:var(--income)}
.tlist{background:var(--surface);border:1px solid var(--border);border-radius:14px;overflow:hidden}
.trow{display:flex;align-items:flex-start;padding:10px 14px;border-bottom:1px solid var(--border);animation:fadeUp .18s cubic-bezier(.22,1,.36,1) both;gap:8px;cursor:pointer}
.trow:last-child{border-bottom:none}
.trowl{display:flex;flex-direction:column;gap:2px;flex:1;min-width:0}
.trowname{font-size:13px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.trowmemo{font-size:11px;color:var(--text2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-style:italic}
.trowcat{font-family:'DM Mono',monospace;font-size:10px;color:var(--muted)}
.trowr{display:flex;flex-direction:column;align-items:flex-end;gap:2px;flex-shrink:0}
.trowamt{font-size:13px;font-weight:600;font-variant-numeric:tabular-nums}
.trowamt.expense{color:var(--expense)}.trowamt.income{color:var(--income)}.trowamt.transfer{color:var(--transfer)}
.trowvia{font-family:'DM Mono',monospace;font-size:10px;color:var(--muted)}
.tempty{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:32px 20px;text-align:center;font-size:13px;color:var(--muted)}
.nw{background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:18px 20px}
.nwlbl{font-family:'DM Mono',monospace;font-size:10px;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);margin-bottom:5px}
.nwamt{font-size:32px;font-weight:700;font-variant-numeric:tabular-nums;letter-spacing:-.02em}
.nwamt.pos{color:var(--income)}.nwamt.neg{color:var(--expense)}
.nwsub{font-family:'DM Mono',monospace;font-size:10px;color:var(--muted);margin-top:3px}
.accs{background:var(--surface);border:1px solid var(--border);border-radius:14px;overflow:hidden}
.accrow{display:flex;justify-content:space-between;align-items:center;padding:13px 14px;border-bottom:1px solid var(--border);cursor:pointer;transition:background .15s}
.accrow:last-child{border-bottom:none}
.accrow:active{background:var(--surface2)}
.accl{display:flex;flex-direction:column;gap:2px}
.accname{font-size:14px;font-weight:600}
.accmeta{font-family:'DM Mono',monospace;font-size:10px;color:var(--muted)}
.accr{display:flex;flex-direction:column;align-items:flex-end;gap:2px}
.accbal{font-size:14px;font-weight:700;font-variant-numeric:tabular-nums}
.accbal.pos{color:var(--income)}.accbal.neg{color:var(--expense)}.accbal.zero{color:var(--muted)}
.accchev{color:var(--muted);font-size:14px}
.back{display:flex;align-items:center;gap:8px;color:var(--text2);cursor:pointer;font-size:13px;font-weight:600;padding:0 0 4px;transition:color .15s}
.back:hover{color:var(--accent)}
.afbar{display:flex;gap:6px}
.afc{font-family:'DM Sans',sans-serif;font-size:12px;font-weight:500;padding:5px 14px;border-radius:20px;border:1px solid var(--border2);background:var(--surface);color:var(--text2);cursor:pointer;transition:all .15s}
.afc.active{background:var(--accent);border-color:var(--accent);color:#051010;font-weight:600}
.more{background:var(--surface);border:1px solid var(--border);border-radius:14px;overflow:hidden}
.mrow{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid var(--border)}
.mrow:last-child{border-bottom:none}
.mrowl{display:flex;flex-direction:column;gap:2px}
.mrowname{font-size:13px;font-weight:600}
.mrowsub{font-family:'DM Mono',monospace;font-size:10px;color:var(--muted)}
.mrowr{display:flex;flex-direction:column;align-items:flex-end;gap:3px}
.mamount{font-size:13px;font-weight:700;font-variant-numeric:tabular-nums}
.mamount.pos{color:var(--income)}.mamount.neg{color:var(--expense)}.mamount.n{color:var(--text2)}
.gbar{height:3px;background:var(--surface3);border-radius:2px;overflow:hidden;width:72px;margin-top:2px}
.gfill{height:100%;border-radius:2px;background:var(--accent);transition:width .6s cubic-bezier(.22,1,.36,1)}
.gfill.full{background:var(--income)}
.t5r{display:flex;align-items:center;padding:11px 14px;border-bottom:1px solid var(--border);gap:8px}
.t5r:last-child{border-bottom:none}
.t5rank{font-family:'DM Mono',monospace;font-size:10px;color:var(--muted);width:14px;flex-shrink:0}
.t5l{flex:1;display:flex;flex-direction:column;gap:2px;min-width:0}
.t5n{font-size:13px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.t5c{font-family:'DM Mono',monospace;font-size:10px;color:var(--muted)}
.t5a{font-size:13px;font-weight:700;font-variant-numeric:tabular-nums;color:var(--expense);flex-shrink:0}
.mr2{display:flex;align-items:center;padding:11px 14px;border-bottom:1px solid var(--border);gap:8px}
.mr2:last-child{border-bottom:none}
.mr2n{font-size:13px;font-weight:600;flex:1;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.mr2r{display:flex;flex-direction:column;align-items:flex-end;gap:1px;flex-shrink:0}
.mr2a{font-size:13px;font-weight:700;font-variant-numeric:tabular-nums;color:var(--expense)}
.mr2c{font-family:'DM Mono',monospace;font-size:10px;color:var(--muted)}
.hbr{display:flex;align-items:center;padding:11px 14px;border-bottom:1px solid var(--border);cursor:pointer;gap:10px}
.hbr:last-child{border-bottom:none}
.hbrl{flex:1;display:flex;flex-direction:column;gap:4px;min-width:0}
.hbrname{font-size:13px;font-weight:600}
.hbrtrack{height:4px;background:var(--surface3);border-radius:2px;overflow:hidden;width:100%;position:relative}
.hbrassigned{position:absolute;top:0;left:0;height:100%;background:rgba(42,157,159,.2);border-radius:2px}
.hbract{position:absolute;top:0;left:0;height:100%;border-radius:2px}
.hbract.ok{background:var(--accent)}.hbract.warn{background:var(--warn)}.hbract.over{background:var(--expense)}
.hbrr{font-size:13px;font-weight:700;font-variant-numeric:tabular-nums;flex-shrink:0}
.hbrr.pos{color:var(--income)}.hbrr.neg{color:var(--expense)}.hbrr.warn{color:var(--warn)}
.ts{font-family:'DM Mono',monospace;font-size:10px;color:var(--muted);text-align:center;padding:4px 0 8px}
.seeall{font-family:'DM Mono',monospace;font-size:10px;color:var(--accent);text-align:right;padding:1px 2px;cursor:pointer;letter-spacing:.04em;text-transform:uppercase}
.home-hey{font-family:'Syne',sans-serif;font-size:28px;font-weight:800;letter-spacing:-.03em;line-height:1.1}
.home-sub{font-size:14px;color:var(--text2);margin-top:5px;line-height:1.4}
.hero-from{font-size:12px;color:var(--text2);margin-top:8px;position:relative;z-index:1}
.home-sechdr{display:flex;justify-content:space-between;align-items:baseline;padding:2px 0 0}
.home-seclbl{font-family:'DM Mono',monospace;font-size:10px;letter-spacing:.1em;text-transform:uppercase;color:var(--muted)}
.goals-scroll{display:flex;gap:10px;overflow-x:auto;padding-bottom:4px;-webkit-overflow-scrolling:touch}
.goals-scroll::-webkit-scrollbar{display:none}
.gcard{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:14px;flex-shrink:0;width:130px;display:flex;flex-direction:column;align-items:center;gap:4px;animation:fadeUp .2s cubic-bezier(.22,1,.36,1)}
.gcard-pct{position:relative;width:56px;height:56px;margin-bottom:2px}
.gcard-svg{position:absolute;top:0;left:0;width:100%;height:100%;transform:rotate(-90deg)}
.gcard-num{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-family:'DM Mono',monospace;font-size:13px;font-weight:500}
.gcard-name{font-size:12px;font-weight:600;text-align:center;line-height:1.2}
.gcard-sub{font-family:'DM Mono',monospace;font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:.06em}
.gcard-val{font-family:'DM Mono',monospace;font-size:12px;font-weight:500;font-variant-numeric:tabular-nums}
.hbudrow{display:flex;align-items:center;padding:12px 14px;border-bottom:1px solid var(--border);gap:12px;cursor:pointer}
.hbudrow:last-child{border-bottom:none}
.hbudrow:active{background:var(--surface2)}
.hbudl{flex:1;min-width:0}
.hbudname{font-size:14px;font-weight:600;margin-bottom:6px}
.hbudbar{height:4px;background:var(--surface3);border-radius:2px;overflow:hidden}
.hbudfill{height:100%;border-radius:2px;transition:width .6s cubic-bezier(.22,1,.36,1)}
.hbudfill.ok{background:var(--accent)}.hbudfill.warn{background:var(--warn)}.hbudfill.over{background:var(--expense)}
.hbudr{text-align:right;flex-shrink:0}
.hbudamt{font-size:15px;font-weight:700;font-variant-numeric:tabular-nums;line-height:1}
.hbudamt.pos{color:var(--income)}.hbudamt.neg{color:var(--expense)}.hbudamt.warn{color:var(--warn)}
.hbudsub{font-family:'DM Mono',monospace;font-size:10px;color:var(--muted);margin-top:2px}
.txn-idx{font-family:'DM Mono',monospace;font-size:9px;color:var(--muted);width:16px;flex-shrink:0;text-align:right;padding-top:2px}
.sumbar{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:14px 16px}
.sumbar-row{display:flex;justify-content:space-between;margin-bottom:6px}
.sumbar-lbl{font-family:'DM Mono',monospace;font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em}
.sumbar-val{font-family:'DM Mono',monospace;font-size:10px;font-variant-numeric:tabular-nums;color:var(--text)}
.sumbar-track{height:6px;background:var(--surface3);border-radius:3px;overflow:hidden;position:relative}
.sumbar-sub{display:flex;justify-content:space-between;margin-top:5px}
.sumbar-sublbl{font-size:11px;color:var(--text2)}
.sumbar-subval{font-family:'DM Mono',monospace;font-size:10px;font-variant-numeric:tabular-nums;color:var(--expense)}
.dbg{position:fixed;inset:0;z-index:10000;background:rgba(11,11,13,.97);display:flex;flex-direction:column;font-family:'DM Mono',monospace}
.dbg.hidden{display:none}
.dbghdr{padding:14px 16px 10px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;flex-shrink:0}
.dbgtitle{font-family:'Syne',sans-serif;font-size:14px;font-weight:700;color:var(--warn)}
.dbgclose{background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text2);cursor:pointer;padding:6px 12px;font-size:11px;font-family:'DM Mono',monospace}
.dbgtabs{display:flex;border-bottom:1px solid var(--border);flex-shrink:0}
.dbgtab{flex:1;padding:10px 4px;text-align:center;cursor:pointer;font-size:10px;color:var(--muted);border-bottom:2px solid transparent;letter-spacing:.06em;text-transform:uppercase;transition:all .15s}
.dbgtab.active{color:var(--warn);border-bottom-color:var(--warn)}
.dbgbody{flex:1;overflow-y:auto;padding:12px;display:flex;flex-direction:column;gap:8px}
.dbgbody::-webkit-scrollbar{display:none}
.dbgsec{background:var(--surface);border:1px solid var(--border);border-radius:10px;overflow:hidden}
.dbgst{padding:7px 12px;background:var(--surface2);border-bottom:1px solid var(--border);color:var(--text2);font-size:10px;letter-spacing:.08em;text-transform:uppercase}
.dbgrow{display:flex;justify-content:space-between;align-items:flex-start;gap:10px;padding:6px 12px;border-bottom:1px solid var(--border)}
.dbgrow:last-child{border-bottom:none}
.dbgk{color:var(--muted);flex-shrink:0;font-size:10px}
.dbgv{color:var(--text);text-align:right;word-break:break-all;font-size:10px}
.dbgv.ok{color:var(--income)}.dbgv.bad{color:var(--expense)}.dbgv.wrn{color:var(--warn)}
.dbgnote{padding:7px 12px;color:var(--warn);font-size:10px;line-height:1.5;border-top:1px solid var(--border)}
.dbgempty{padding:20px;text-align:center;color:var(--muted);font-size:11px}
.dbggrid{display:grid;grid-template-columns:1fr 1fr}
.dbgstat{padding:9px 12px;border-right:1px solid var(--border);border-bottom:1px solid var(--border)}
.dbgstat:nth-child(2n){border-right:none}
.dbgstat:nth-last-child(-n+2){border-bottom:none}
.dbgslbl{font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;margin-bottom:2px}
.dbgsval{font-size:12px;color:var(--text);font-weight:500}
@keyframes fadeUp{from{opacity:0;transform:translateY(7px)}to{opacity:1;transform:translateY(0)}}
@media(prefers-reduced-motion:reduce){*,*::before,*::after{animation-duration:.01ms!important;transition-duration:.01ms!important}}
</style>
</head>
<body>
<div class="app">
  <div class="hdr">
    <div class="wordmark">tribe<em>.</em></div>
    <div class="hdr-r">
      <div class="mnav">
        <button class="marrow" onclick="changeMonth(-1)">&#8249;</button>
        <div class="mlabel" id="mlabel">---</div>
        <button class="marrow" onclick="changeMonth(1)">&#8250;</button>
      </div>
      <div class="hbtn" id="dbgbtn" onclick="toggleDbg()">&#128269;</div>
      <div class="hbtn" id="refbtn" onclick="loadData()">&#8635;</div>
    </div>
  </div>
  <div class="pw" id="pw">
    <div class="pages" id="pages">
      <div class="page" id="p0"><div class="pi" id="hc"><div class="sc"><div class="pr"><div class="pdot"></div></div><div class="stext">Loading...</div></div></div></div>
      <div class="page" id="p1"><div class="pi" id="pc"><div class="sc"><div class="pr"><div class="pdot"></div></div><div class="stext">Loading budget...</div></div></div></div>
      <div class="page" id="p2"><div class="pi" id="sc2"><div class="sc"><div class="pr"><div class="pdot"></div></div><div class="stext">Loading...</div></div></div></div>
      <div class="page" id="p3"><div class="pi" id="ac"><div class="sc"><div class="pr"><div class="pdot"></div></div><div class="stext">Loading...</div></div></div></div>
      <div class="page" id="p4"><div class="pi" id="mc"><div class="sc"><div class="pr"><div class="pdot"></div></div><div class="stext">Loading...</div></div></div></div>
    </div>
  </div>
  <div class="tabbar">
    <div class="tab active" data-tab="0" onclick="switchTab(0)">
      <div class="ti"><svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg></div>
      <div class="tlabel">Home</div>
    </div>
    <div class="tab" data-tab="1" onclick="switchTab(1)">
      <div class="ti" style="position:relative">
        <svg viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
        <span class="tbadge" id="planbadge" style="display:none">0</span>
      </div>
      <div class="tlabel">Plan</div>
    </div>
    <div class="tab" data-tab="2" onclick="switchTab(2)">
      <div class="ti"><svg viewBox="0 0 24 24"><path d="M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01"/></svg></div>
      <div class="tlabel">Spending</div>
    </div>
    <div class="tab" data-tab="3" onclick="switchTab(3)">
      <div class="ti"><svg viewBox="0 0 24 24"><rect x="2" y="5" width="20" height="14" rx="2"/><path d="M2 10h20"/></svg></div>
      <div class="tlabel">Accounts</div>
    </div>
    <div class="tab" data-tab="4" onclick="switchTab(4)">
      <div class="ti"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></svg></div>
      <div class="tlabel">More</div>
    </div>
  </div>
</div>
<div class="dbg hidden" id="dbgpanel">
  <div class="dbghdr">
    <div class="dbgtitle">&#128269; Debug</div>
    <button class="dbgclose" onclick="toggleDbg()">Close</button>
  </div>
  <div class="dbgtabs">
    <div class="dbgtab active" onclick="switchDbgTab(0)" id="dt0">Overview</div>
    <div class="dbgtab" onclick="switchDbgTab(1)" id="dt1">Budget</div>
    <div class="dbgtab" onclick="switchDbgTab(2)" id="dt2">Activity</div>
    <div class="dbgtab" onclick="switchDbgTab(3)" id="dt3">Snapshot</div>
  </div>
  <div class="dbgbody" id="dbgbody"><div class="dbgempty">Load data first.</div></div>
</div>
<script>

// COLUMN MAP (0-indexed, verified from screenshots 2026-02-21)
// BUDGET: 0=BudgetRowID 1=GroupKey 2=GroupID 3=CategoryID 4=GroupSort
//         5=MonthStart  6=Group    7=Category  8=MonthlyGoal  9=MonthlyGoal2
//         10=Assigned   11=Funded  12=TotalAssigned  13=Activity  14=Available  15=Overspent
//
// ACTIVITY: 0=Date  1=Type  2=Amount  3=Merchant  4=PaymentMethod
//           5=Category  6=Group  7=Memo  8=Review  9=Expense  10=Income
//           11=MonthStart(label)  12=GroupKey  13=GroupSort  14=CategoryID  ...
//
// SNAPSHOT: 0=MonthStart  1=CashStart  2=InflowExternal  3=AssignedThisMonth
//           4=OutflowExternal  5=CashEnd  6=ReadyToAssignEnd

var WEBHOOK='https://script.google.com/macros/s/AKfycbxArmvsbhZIthFv1qqy2cEl5pRRZin2-V-RFdpbuOh--1iESw4m1E8NXo3XtaKqpu-nng/exec';
var ACCOUNTS=['BDO','BPI','Cash','GCash','Maribank','Maya','UnionBank','UnionBank Credit'];
var MONTHS=['January','February','March','April','May','June','July','August','September','October','November','December'];
var GORDER=['Income','Home','Pets','Health','Quality Of Life','Stellar Rebels','Sinking','Emergency','Goals'];

var viewMonth=new Date(); viewMonth.setDate(1);
var curTab=0,rawB=null,rawA=null,rawS=null,parsed=null,lastUp=null;
var dismissed={},spendFilter='All',accDet=null,dbgOpen=false,dbgTab=0;

// ── UTILS ────────────────────────────────────────────────────────────────
function parseDate(v){
  if(v==null||v===undefined)return null;
  if(v instanceof Date)return isNaN(v.getTime())?null:v;
  var s=String(v).trim();
  if(!s||s==='-'||s==='--')return null;
  var m=s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
  if(m)return new Date(+m[3],+m[1]-1,+m[2]);
  var m2=s.match(/^(\d{4})-(\d{2})-(\d{2})/);
  if(m2)return new Date(+m2[1],+m2[2]-1,+m2[3]);
  if(/^\d+$/.test(s)){var n=parseInt(s,10);if(n>40000&&n<60000){var e=new Date(Date.UTC(1899,11,30)+n*86400000);return new Date(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate());}}
  if(/^[A-Za-z]/.test(s))return null;
  var d=new Date(v);return isNaN(d.getTime())?null:d;
}
function pn(v){if(typeof v==='number')return v;return parseFloat(String(v||'0').replace(/[^0-9.\-]/g,''))||0;}
function peso(n){return '\u20b1'+Math.abs(n).toLocaleString('en-PH',{minimumFractionDigits:2,maximumFractionDigits:2});}
function sh(n){var a=Math.abs(n);if(a>=1e6)return '\u20b1'+(a/1e6).toFixed(1)+'M';if(a>=1e3)return '\u20b1'+(a/1e3).toFixed(1)+'k';return '\u20b1'+a.toFixed(0);}
function fd(d){if(!d)return '--';return d.toLocaleDateString('en-PH',{month:'short',day:'numeric'});}
function esc(s){return s.replace(/'/g,"\\'");}
function haptic(){try{if(navigator.vibrate)navigator.vibrate(22);}catch(e){}}

function bHdr(rows){if(!rows||!rows.length)return false;return !parseDate(String(rows[0][5]||''));}
function aHdr(rows){if(!rows||!rows.length)return false;return !parseDate(String(rows[0][0]||''));}
function sHdr(rows){if(!rows||!rows.length)return false;return !parseDate(String(rows[0][0]||''));}

// ── TOUCH ───────────────────────────────────────────────────────────────
var tx0=0,ty0=0,pullY=0,pulling=false;
var pw=document.getElementById('pw');
pw.addEventListener('touchstart',function(e){tx0=e.touches[0].clientX;ty0=e.touches[0].clientY;pullY=e.touches[0].clientY;},{passive:true});
pw.addEventListener('touchend',function(e){
  var dx=e.changedTouches[0].clientX-tx0,dy=e.changedTouches[0].clientY-ty0;
  if(Math.abs(dx)>Math.abs(dy)&&Math.abs(dx)>48){if(dx<0&&curTab<4)switchTab(curTab+1);if(dx>0&&curTab>0)switchTab(curTab-1);}
  pulling=false;
},{passive:true});
pw.addEventListener('touchmove',function(e){
  var page=document.getElementById('p'+curTab);
  if(page&&page.scrollTop===0&&(e.touches[0].clientY-pullY)>72&&!pulling){pulling=true;loadData();}
},{passive:true});

// ── MONTH ────────────────────────────────────────────────────────────────
function setML(){document.getElementById('mlabel').textContent=MONTHS[viewMonth.getMonth()].slice(0,3).toUpperCase()+' '+viewMonth.getFullYear();}
function changeMonth(d){viewMonth=new Date(viewMonth.getFullYear(),viewMonth.getMonth()+d,1);setML();if(rawB){parsed=parseAll();renderCur();}}

// ── TABS ─────────────────────────────────────────────────────────────────
function switchTab(idx){
  curTab=idx;
  document.querySelectorAll('.tab').forEach(function(t){t.classList.toggle('active',+t.dataset.tab===idx);});
  document.getElementById('pages').style.transform='translateX(-'+(idx*20)+'%)';
  if(parsed)renderCur();
}
function renderCur(){
  accDet=null;
  if(curTab===0)renderHome();
  else if(curTab===1)renderPlan();
  else if(curTab===2)renderSpend();
  else if(curTab===3)renderAccounts();
  else if(curTab===4)renderMore();
}

// ── FETCH ────────────────────────────────────────────────────────────────
function loadData(){
  var btn=document.getElementById('refbtn');
  btn.style.opacity='0.35';btn.style.pointerEvents='none';
  fetch(WEBHOOK)
    .then(function(r){if(!r.ok)throw new Error('HTTP '+r.status);return r.json();})
    .then(function(j){
      if(j.status==='error')throw new Error(j.message);
      if(!j.budget||!j.activity||!j.snapshot)throw new Error('Missing tabs in response');
      rawB=j.budget;rawA=j.activity;rawS=j.snapshot;
      lastUp=new Date();parsed=parseAll();renderCur();
      if(dbgOpen)renderDbg();
      try{localStorage.setItem('tribe_v4',JSON.stringify({b:rawB,a:rawA,s:rawS,ts:lastUp.toISOString()}));}catch(e){}
    })
    .catch(function(e){showErr(e.message);})
    .finally(function(){btn.style.opacity='';btn.style.pointerEvents='';});
}
function loadCache(){
  try{
    var c=JSON.parse(localStorage.getItem('tribe_v4')||'null');
    if(!c)return false;
    rawB=c.b;rawA=c.a;rawS=c.s;lastUp=new Date(c.ts);parsed=parseAll();renderCur();return true;
  }catch(e){return false;}
}
function showErr(msg){
  var h='<div class="sc"><div class="etitle">Load failed</div><div class="stext">'+msg+'</div><button class="btn-retry" onclick="loadData()">Retry</button></div>';
  ['hc','pc'].forEach(function(id){var el=document.getElementById(id);if(el)el.innerHTML=h;});
}

// ── PARSE ────────────────────────────────────────────────────────────────
function parseAll(){
  var vm=viewMonth.getMonth(),vy=viewMonth.getFullYear();
  var bData=bHdr(rawB)?rawB.slice(1):rawB;
  var aData=aHdr(rawA)?rawA.slice(1):rawA;
  var sData=sHdr(rawS)?rawS.slice(1):rawS;

  // Budget rows for this month — filter by col 5 (MonthStart date)
  var bRows=bData.filter(function(row){var d=parseDate(row[5]);return d&&d.getMonth()===vm&&d.getFullYear()===vy;});

  // Category map from Budget
  var catMap={};
  bRows.forEach(function(row){
    var grp=String(row[6]||'').trim(),cat=String(row[7]||'').trim();
    if(!cat||!grp)return;
    catMap[cat]={group:grp,goal:pn(row[8]),assigned:pn(row[10]),funded:pn(row[11]),
      totalAssigned:pn(row[12]),activity:pn(row[13]),available:pn(row[14]),overspent:pn(row[15])};
  });

  // Snapshot for this month
  var rta=0,atm=0,inflowExt=0,outflowExt=0;
  for(var i=0;i<sData.length;i++){
    var sr=sData[i],sd=parseDate(sr[0]);
    if(sd&&sd.getMonth()===vm&&sd.getFullYear()===vy){inflowExt=pn(sr[2]);atm=pn(sr[3]);outflowExt=pn(sr[4]);rta=pn(sr[6]);break;}
  }

  // Activity — filter by col 0 (transaction Date), NOT col 11 which is a text label
  var monthAct=aData.filter(function(row){var d=parseDate(row[0]);return d&&d.getMonth()===vm&&d.getFullYear()===vy;});
  var balRows=aData.filter(function(row){return String(row[1]).trim()==='Balance';});
  var expRows=monthAct.filter(function(r){return String(r[1]).trim()==='Expense';});
  var incRows=monthAct.filter(function(r){return String(r[1]).trim()==='Income';});

  var totalInc=incRows.reduce(function(s,r){return s+Math.abs(pn(r[2]));},0);
  var totalExp=expRows.reduce(function(s,r){return s+Math.abs(pn(r[2]));},0);

  // Txns per category — include Memo col 7
  var txnsByCat={};
  expRows.forEach(function(row){
    var cat=String(row[5]||'').trim();if(!cat)return;
    if(!txnsByCat[cat])txnsByCat[cat]=[];
    txnsByCat[cat].push({date:parseDate(row[0]),type:'expense',amount:pn(row[2]),
      merchant:String(row[3]||'').trim(),payment:String(row[4]||'').trim(),
      cat:cat,group:String(row[6]||'').trim(),memo:String(row[7]||'').trim()});
  });

  // Build categories
  var categories=[];
  Object.keys(catMap).forEach(function(cat){
    var d=catMap[cat];
    var actAmt=Math.abs(d.activity);
    var ta=d.totalAssigned;
    var pct=ta>0?Math.min((actAmt/ta)*100,100):(actAmt>0?100:0);
    var status=d.available<0?'over':pct>=80?'warn':(d.available===0&&ta===0)?'zero':'ok';
    var txns=(txnsByCat[cat]||[]).sort(function(a,b){return b.date-a.date;});
    categories.push({cat:cat,group:d.group,goal:d.goal,assigned:d.assigned,
      funded:d.funded,totalAssigned:ta,activity:d.activity,actAmt:actAmt,
      available:d.available,overspent:d.overspent,pct:pct,status:status,txns:txns});
  });

  // Account balances from ALL-TIME Balance rows
  var accBals={};
  ACCOUNTS.forEach(function(acc){
    var rows=balRows.filter(function(r){return String(r[4]||'').trim()===acc;})
      .sort(function(a,b){var da=parseDate(a[0])||new Date(0),db=parseDate(b[0])||new Date(0);return db-da;});
    accBals[acc]=rows.length?pn(rows[0][2]):0;
  });
  var netWorth=Object.values(accBals).reduce(function(s,v){return s+v;},0);

  // Txns by account this month
  var txnsByAcc={};
  ACCOUNTS.forEach(function(acc){
    txnsByAcc[acc]=monthAct
      .filter(function(r){return String(r[4]||'').trim()===acc&&String(r[1]).trim()!=='Balance';})
      .map(function(r){return{date:parseDate(r[0]),type:String(r[1]).trim().toLowerCase(),
        amount:pn(r[2]),merchant:String(r[3]||'').trim(),payment:acc,
        cat:String(r[5]||'').trim(),group:String(r[6]||'').trim(),memo:String(r[7]||'').trim()};})
      .sort(function(a,b){return b.date-a.date;});
  });

  // All month txns (Spending tab)
  var allTxns=monthAct
    .filter(function(r){return String(r[1]).trim()!=='Balance';})
    .map(function(r){return{date:parseDate(r[0]),type:String(r[1]).trim().toLowerCase(),
      amount:pn(r[2]),merchant:String(r[3]||'').trim(),payment:String(r[4]||'').trim(),
      cat:String(r[5]||'').trim(),group:String(r[6]||'').trim(),memo:String(r[7]||'').trim()};})
    .sort(function(a,b){return b.date-a.date;});

  var overspent=categories.filter(function(c){return c.available<0;});
  var totalAssignedAll=bRows.reduce(function(s,row){return s+pn(row[12]);},0);

  var top5=expRows.slice()
    .sort(function(a,b){return Math.abs(pn(a[2]))-Math.abs(pn(b[2]));})
    .slice(-5).reverse()
    .map(function(r){return{merchant:String(r[3]||'').trim(),cat:String(r[5]||'').trim(),memo:String(r[7]||'').trim(),amount:Math.abs(pn(r[2]))};});

  var mMap={};
  expRows.forEach(function(r){var mn=String(r[3]||'').trim()||'--';if(!mMap[mn])mMap[mn]={total:0,count:0};mMap[mn].total+=Math.abs(pn(r[2]));mMap[mn].count++;});
  var merch=Object.keys(mMap).sort(function(a,b){return mMap[b].total-mMap[a].total;}).slice(0,10)
    .map(function(n){return{name:n,total:mMap[n].total,count:mMap[n].count};});

  return{categories:categories,overspent:overspent,readyToAssign:rta,
    assignedThisMonth:atm,inflowExt:inflowExt,outflowExt:outflowExt,
    totalInc:totalInc,totalExp:totalExp,totalAssignedAll:totalAssignedAll,
    accBals:accBals,netWorth:netWorth,txnsByAcc:txnsByAcc,allTxns:allTxns,
    top5:top5,merch:merch,
    _bData:bData,_aData:aData,_sData:sData,_bRows:bRows,_mAct:monthAct,
    _dbg:{bHdr:bHdr(rawB),aHdr:aHdr(rawA),sHdr:sHdr(rawS),
      rawB:rawB.length,rawA:rawA.length,rawS:rawS.length,
      bMo:bRows.length,aMo:monthAct.length,
      cats:categories.length,expCt:expRows.length,incCt:incRows.length,balCt:balRows.length}};
}

// ── HOME ──────────────────────────────────────────────────────────────────
function renderHome(){
  var p=parsed,el=document.getElementById('hc');
  var now=new Date();
  var dim=new Date(viewMonth.getFullYear(),viewMonth.getMonth()+1,0).getDate();
  var dom=(viewMonth.getMonth()===now.getMonth()&&viewMonth.getFullYear()===now.getFullYear())?now.getDate():dim;
  var moPct=Math.round((dom/dim)*100);
  var budPct=p.totalAssignedAll>0?Math.round((p.totalExp/p.totalAssignedAll)*100):0;
  var pace=budPct>moPct+10?'over':budPct>moPct-5?'warn':'good';
  var pLbl=pace==='over'?'Over pace':pace==='warn'?'On watch':'On track';
  var hs=p.readyToAssign<0?'neg':p.readyToAssign<p.totalInc*0.1?'warn':'pos';
  var html='';

  // ── Hey, Miles. ──
  html+='<div>'
    +'<div class="home-hey">Hey, Miles.</div>'
    +'<div class="home-sub">You have '
    +(p.readyToAssign>=0
      ?'<span style="color:var(--income);font-weight:600">'+peso(p.readyToAssign)+'</span> ready to assign.'
      :'<span style="color:var(--expense);font-weight:600">'+peso(Math.abs(p.readyToAssign))+'</span> over-assigned.')
    +'</div>'
    +'</div>';

  // ── Overspent alerts ──
  p.overspent.forEach(function(c){
    if(dismissed[c.cat])return;
    html+='<div class="alert e" style="gap:10px">'
      +'<span style="font-size:16px;flex-shrink:0">⚠</span>'
      +'<div class="atxt" style="flex:1">'
      +'<strong style="color:var(--expense);display:block">'+c.cat+' is overspent</strong>'
      +'<span style="font-size:12px">&#8369;0 left &mdash; over by '+peso(Math.abs(c.available))+' this period</span>'
      +'</div>'
      +'<button class="ax" onclick="dismiss(\''+esc(c.cat)+'\')">&#215;</button></div>';
  });

  // ── Left to Assign hero ──
  html+='<div class="hero"><div class="hglow '+hs+'"></div>'
    +'<div class="hi" style="position:relative;z-index:1">'
    +'<div class="hmlbl">Left to Assign</div>'
    +'<div class="hamt '+hs+'" style="font-size:44px;margin:4px 0">'+(p.readyToAssign<0?'&#8722;':'')+peso(Math.abs(p.readyToAssign))+'</div>'
    +'<div class="hero-from">From '+peso(p.totalInc)+' income this period</div>'
    +'</div>'
    +'<div class="hstats">'
    +'<div class="hs"><div class="hslbl">Income</div><div class="hsval ic">'+sh(p.totalInc)+'</div></div>'
    +'<div class="hs"><div class="hslbl">Assigned</div><div class="hsval nc">'+sh(p.totalAssignedAll)+'</div></div>'
    +'<div class="hs"><div class="hslbl">Spent</div><div class="hsval ec">'+sh(p.totalExp)+'</div></div>'
    +'</div></div>';

  // ── Spending Pace ──
  html+='<div class="pace"><div class="pace-hdr">'
    +'<div class="pace-lbl">Spending Pace &mdash; '+MONTHS[viewMonth.getMonth()].slice(0,3).toUpperCase()+'</div>'
    +'<div class="pchip '+pace+'">'+pLbl+'</div></div>'
    +'<div class="prow"><span class="prl">Month progress</span><span class="prv">Day '+dom+' of '+dim+' &nbsp;'+moPct+'%</span></div>'
    +'<div class="bt"><div class="bf ic" style="width:'+moPct+'%"></div></div>'
    +'<div class="prow"><span class="prl">Budget used</span>'
    +'<span class="prv"><span style="font-weight:700;color:'+(pace==='over'?'var(--expense)':pace==='warn'?'var(--warn)':'var(--income)')+'">'+budPct+'%</span> of '+sh(p.totalAssignedAll)+'</span></div>'
    +'<div class="bt last"><div class="bf '+(pace==='over'?'ec':pace==='warn'?'wc':'ic')+'" style="width:'+Math.min(budPct,100)+'%"></div></div>'
    +'</div>';

  // ── Goals ──
  var goals=p.categories.filter(function(c){return c.group==='Goals'||c.group==='Emergency';});
  if(goals.length){
    html+='<div class="home-sechdr"><span class="home-seclbl">Goals</span><span class="seeall" onclick="switchTab(4)">Manage</span></div>';
    html+='<div class="goals-scroll">';
    goals.forEach(function(g){
      var target=g.goal||g.totalAssigned;
      var funded=g.totalAssigned;
      var gpct=target>0?Math.min(Math.round((funded/target)*100),100):0;
      var remaining=Math.max(target-funded,0);
      var gclr=gpct>=100?'var(--income)':gpct>=60?'var(--accent)':'var(--warn)';
      var r=22,circ=2*Math.PI*r;
      var fill=circ*(gpct/100),gap=circ-fill;
      html+='<div class="gcard">'
        +'<div class="gcard-pct">'
        +'<svg class="gcard-svg" viewBox="0 0 56 56">'
        +'<circle cx="28" cy="28" r="'+r+'" fill="none" stroke="var(--surface3)" stroke-width="4"/>'
        +'<circle cx="28" cy="28" r="'+r+'" fill="none" stroke="'+gclr+'" stroke-width="4"'
        +' stroke-dasharray="'+fill.toFixed(1)+' '+gap.toFixed(1)+'" stroke-linecap="round"/>'
        +'</svg>'
        +'<div class="gcard-num" style="color:'+gclr+'">'+gpct+'%</div>'
        +'</div>'
        +'<div class="gcard-name">'+g.cat+'</div>'
        +'<div class="gcard-sub">To go</div>'
        +'<div class="gcard-val" style="color:'+gclr+'">'+peso(remaining)+'</div>'
        +'</div>';
    });
    html+='</div>';
  }

  // ── Budget ── (mockup style: name + progress bar left, ₱spent of ₱budget right)
  var budCats=p.categories.filter(function(c){
    return c.group!=='Income'&&c.group!=='Goals'&&c.group!=='Emergency'&&c.group!=='Sinking'&&c.totalAssigned>0;
  }).sort(function(a,b){return b.actAmt-a.actAmt;}).slice(0,6);

  if(budCats.length){
    html+='<div class="home-sechdr"><span class="home-seclbl">Budget</span><span class="seeall" onclick="switchTab(1)">See all</span></div>';
    html+='<div class="tlist">';
    budCats.forEach(function(c){
      var spentPct=c.totalAssigned>0?Math.min(Math.round((c.actAmt/c.totalAssigned)*100),100):(c.actAmt>0?100:0);
      var bc=c.status==='over'?'over':c.status==='warn'?'warn':'ok';
      var amtCls=c.status==='over'?'neg':c.status==='warn'?'warn':'pos';
      html+='<div class="hbudrow" onclick="switchTab(1)">'
        +'<div class="hbudl">'
        +'<div class="hbudname">'+c.cat+'</div>'
        +'<div class="hbudbar"><div class="hbudfill '+bc+'" style="width:'+spentPct+'%"></div></div>'
        +'</div>'
        +'<div class="hbudr">'
        +'<div class="hbudamt '+amtCls+'">'+(c.available<0?'&#8722;':'')+peso(Math.abs(c.available))+'</div>'
        +'<div class="hbudsub">of '+sh(c.totalAssigned)+'</div>'
        +'</div>'
        +'</div>';
    });
    html+='</div>';
  }

  // ── Recent ──
  var recent=p.allTxns.slice(0,5);
  if(recent.length){
    html+='<div class="home-sechdr"><span class="home-seclbl">Recent</span><span class="seeall" onclick="switchTab(2)">All txns</span></div>';
    html+='<div class="tlist">';
    recent.forEach(function(t){
      var cls=t.type==='income'?'income':t.type==='transfer'?'transfer':'expense';
      html+='<div class="trow" onclick="switchTab(2)">'
        +'<div class="trowl">'
        +'<div class="trowname">'+(t.merchant||'--')+'</div>'
        +(t.memo?'<div class="trowmemo">'+t.memo+'</div>':'')
        +'<div class="trowcat">'+(t.cat||t.group||t.type)+' &middot; '+t.payment+' &middot; '+fd(t.date)+'</div>'
        +'</div>'
        +'<div class="trowr">'
        +'<div class="trowamt '+cls+'">'+(t.amount<0?'&#8722;':'+')+peso(Math.abs(t.amount))+'</div>'
        +'</div>'
        +'</div>';
    });
    html+='</div>';
  }

  html+='<div class="ts">'+(lastUp?'Updated '+lastUp.toLocaleTimeString('en-PH',{hour:'2-digit',minute:'2-digit'}):'')+'</div>';
  el.innerHTML=html;
}

// ── PLAN ──────────────────────────────────────────────────────────────────
function renderPlan(){
  var p=parsed,el=document.getElementById('pc');
  var lta=p.readyToAssign;
  var hs=lta<0?'neg':lta<p.totalInc*0.15?'warn':'pos';
  var badge=document.getElementById('planbadge');
  badge.style.display=p.overspent.length?'':'none';
  badge.textContent=p.overspent.length;

  var byGrp={};
  p.categories.forEach(function(item){var g=item.group||'Other';if(!byGrp[g])byGrp[g]=[];byGrp[g].push(item);});
  Object.keys(byGrp).forEach(function(g){byGrp[g].sort(function(a,b){
    if(a.status==='over'&&b.status!=='over')return -1;if(b.status==='over'&&a.status!=='over')return 1;return a.available-b.available;});});
  var oGrps=GORDER.filter(function(g){return byGrp[g];}).concat(Object.keys(byGrp).filter(function(g){return GORDER.indexOf(g)<0;}));

  var html='';
  p.overspent.forEach(function(c){
    if(dismissed[c.cat])return;
    html+='<div class="alert e"><div class="atxt"><strong>'+c.cat+' overspent</strong><span>'+peso(Math.abs(c.available))+' over</span></div>'
      +'<button class="ax" onclick="dismiss(\''+esc(c.cat)+'\')">&#215;</button></div>';
  });

  html+='<div class="hero"><div class="hglow '+hs+'"></div><div class="hi">'
    +'<div class="hmlbl">Left to Assign</div>'
    +'<div style="display:flex;justify-content:space-between;align-items:flex-start">'
    +'<div class="hamt '+hs+'">'+(lta<0?'&#8722;':'')+peso(Math.abs(lta))+'</div>'
    +'<div class="hchip '+hs+'">'+(lta<0?'Over-assigned':lta<p.totalInc*0.15?'Low':'On track')+'</div>'
    +'</div></div><div class="hstats" style="margin-top:12px">'
    +'<div class="hs"><div class="hslbl">Income</div><div class="hsval ic">'+sh(p.totalInc)+'</div></div>'
    +'<div class="hs"><div class="hslbl">Spent</div><div class="hsval ec">'+sh(p.totalExp)+'</div></div>'
    +'<div class="hs"><div class="hslbl">Assigned</div><div class="hsval nc">'+sh(p.totalAssignedAll)+'</div></div>'
    +'</div></div>';

  // Overall budget vs activity summary bar
  var sumPct=p.totalAssignedAll>0?Math.min(Math.round((p.totalExp/p.totalAssignedAll)*100),999):0;
  var sumClr=sumPct>100?'var(--expense)':sumPct>80?'var(--warn)':'var(--accent)';
  html+='<div class="sumbar"><div class="sumbar-row">'
    +'<span class="sumbar-lbl">Total Assigned vs Activity</span>'
    +'<span class="sumbar-val">'+peso(p.totalAssignedAll)+'</span></div>'
    +'<div class="sumbar-track" style="height:6px;background:var(--surface3);border-radius:3px;overflow:hidden;position:relative">'
    +'<div style="position:absolute;top:0;left:0;height:100%;width:100%;background:rgba(42,157,159,.18);border-radius:3px"></div>'
    +'<div style="position:absolute;top:0;left:0;height:100%;width:'+Math.min(sumPct,100)+'%;border-radius:3px;background:'+sumClr+';transition:width .6s"></div>'
    +'</div><div class="sumbar-sub">'
    +'<span class="sumbar-sublbl">Activity '+sumPct+'%</span>'
    +'<span class="sumbar-subval">&#8722;'+peso(p.totalExp)+'</span>'
    +'</div></div>';

  html+='<div class="sw"><span class="sico">&#9906;</span>'
    +'<input class="si" id="catq" placeholder="Search categories..." oninput="filterCats(this.value)"></div>';

  var delay=0;
  oGrps.forEach(function(grp){
    var items=byGrp[grp];if(!items||!items.length)return;
    var gAv=items.reduce(function(s,i){return s+i.available;},0);
    var gCls=gAv<0?'neg':gAv>0?'pos':'zero';
    var gid='g_'+grp.replace(/\W+/g,'_');
    html+='<div class="grp"><div class="grphdr" onclick="togGrp(\''+gid+'\')">'
      +'<div class="grptitle"><span class="grptog" id="gt_'+gid+'">&#9662;</span>'+grp+'</div>'
      +'<div class="grpav '+gCls+'">'+(gAv<0?'&#8722;':'')+sh(Math.abs(gAv))+'</div></div>'
      +'<div class="grpcats" id="gc_'+gid+'">';

    items.forEach(function(c){
      var pid='dp_'+c.cat.replace(/\W+/g,'_');
      var bCls=c.status==='over'?'over':c.status==='warn'?'warn':'ok';
      var maxA=Math.max.apply(null,items.map(function(x){return x.totalAssigned;}))||1;
      var aw=Math.round((c.totalAssigned/maxA)*100);
      var actW=c.totalAssigned>0?Math.min(Math.round((c.actAmt/c.totalAssigned)*100),100):(c.actAmt>0?100:0);

      html+='<div class="cat '+c.status+'" style="animation-delay:'+delay+'ms" onclick="togDet(\''+pid+'\')">'
        +'<div class="cattop"><div class="catl"><div class="catname">'+c.cat+'</div>'
        +'<div class="catsub">'+(c.totalAssigned>0?peso(c.totalAssigned)+' budgeted':'no budget')
        +(c.txns.length?' &middot; '+c.txns.length+' txn'+(c.txns.length!==1?'s':''):'')+'</div></div>'
        +'<div class="catr"><div class="catav '+(c.available<0?'neg':c.available===0?'zero':'pos')+'">'
        +(c.available<0?'&#8722;':'')+peso(Math.abs(c.available))+'</div>'
        +(c.actAmt>0?'<div class="catsp">&#8722;'+sh(c.actAmt)+' spent</div>':'')
        +'</div></div>'
        // Dual bar
        +'<div class="catbarwrap">'
        +'<div class="catbarlbls"><span>'+(c.totalAssigned>0?sh(c.actAmt)+' / '+sh(c.totalAssigned):'no budget')+'</span>'
        +'<span>'+(c.totalAssigned>0?Math.round(c.pct)+'%':'')+'</span></div>'
        +'<div class="catbartrack">'
        +'<div class="catbarassigned" style="width:'+aw+'%"></div>'
        +'<div class="catbaract '+bCls+'" style="width:'+Math.round((actW/100)*aw)+'%"></div>'
        +'</div></div>'
        // Detail panel
        +'<div class="det" id="'+pid+'"><div class="detin">'
        +'<div class="detgrid">'
        +'<div class="dstat"><div class="dslbl">Budgeted</div><div class="dsval n">'+peso(c.totalAssigned)+'</div></div>'
        +'<div class="dstat"><div class="dslbl">Activity</div><div class="dsval '+(c.actAmt>0?'neg':'n')+'">'+(c.actAmt>0?'&#8722;':'')+peso(c.actAmt)+'</div></div>'
        +'<div class="dstat"><div class="dslbl">Available</div><div class="dsval '+(c.available<0?'neg':c.available===0?'n':'pos')+'">'+(c.available<0?'&#8722;':'')+peso(Math.abs(c.available))+'</div></div>'
        +(c.goal>0?'<div class="dstat"><div class="dslbl">Goal/mo</div><div class="dsval n">'+peso(c.goal)+'</div></div>':'')
        +'</div>'
        // BvA bar
        +'<div class="bvabarsec">'
        +'<div class="bvalblrow"><span class="bvalbl">Budgeted vs Activity</span>'
        +'<span class="bvaval '+(c.available<0?'ec':c.available===0?'nc':'ic')+'">'+(c.totalAssigned>0?Math.round(c.pct)+'% used':'no budget')+'</span></div>'
        +'<div class="bvatrack">'
        +'<div class="bvaassigned" style="width:100%"></div>'
        +'<div class="bvaact '+bCls+'" style="width:'+Math.round(c.pct)+'%"></div>'
        +'</div>'
        +'<div class="bvasubrow"><span class="bvasubl">Activity '+peso(c.actAmt)+'</span><span class="bvasubl">Budgeted '+peso(c.totalAssigned)+'</span></div>'
        +'</div>'
        // Transactions with numbered index
        +(c.txns.length
          ?'<div class="dettitle">Transactions &middot; '+c.txns.length+'</div>'
            +c.txns.map(function(t,i){
              return '<div class="dtxn"><div class="txn-idx">'+(i+1)+'</div><div class="dtxnl">'
                +'<div class="dtxnname">'+(t.merchant||'--')+'</div>'
                +(t.memo?'<div class="dtxnmemo">'+t.memo+'</div>':'')
                +'<div class="dtxnmeta">'+fd(t.date)+' &middot; '+t.payment+'</div>'
                +'</div><div class="dtxnamt e">&#8722;'+peso(Math.abs(t.amount))+'</div></div>';}).join('')
          :'<div class="dtxnempty">No transactions this month</div>')
        +'</div></div></div>';
      delay+=16;
    });
    html+='</div></div>';
  });
  html+='<div class="ts">'+(lastUp?'Updated '+lastUp.toLocaleTimeString('en-PH',{hour:'2-digit',minute:'2-digit'}):'')+'</div>';
  el.innerHTML=html;
}

function togGrp(id){
  var cats=document.getElementById('gc_'+id),tog=document.getElementById('gt_'+id);
  if(!cats)return;
  var c=cats.classList.toggle('coll');
  cats.style.maxHeight=c?'':cats.scrollHeight+'px';
  if(tog)tog.classList.toggle('coll',c);
}
function togDet(id){
  var det=document.getElementById(id);if(!det)return;
  var wasOpen=det.classList.contains('open');
  document.querySelectorAll('.det.open').forEach(function(d){d.classList.remove('open');});
  if(!wasOpen)det.classList.add('open');
  haptic();
}
function dismiss(cat){dismissed[cat]=true;document.querySelectorAll('.alert').forEach(function(el){var s=el.querySelector('strong');if(s&&s.textContent.indexOf(cat)>=0)el.remove();});}
function filterCats(q){
  var low=q.toLowerCase();
  document.querySelectorAll('.cat').forEach(function(el){var n=(el.querySelector('.catname')||{}).textContent||'';el.style.display=n.toLowerCase().indexOf(low)>=0?'':'none';});
  document.querySelectorAll('.grp').forEach(function(el){var any=[].slice.call(el.querySelectorAll('.cat')).some(function(c){return c.style.display!=='none';});el.style.display=any?'':'none';});
}

// ── SPENDING ─────────────────────────────────────────────────────────────
function renderSpend(){
  var p=parsed,el=document.getElementById('sc2');
  var catSet=['All'];
  p.allTxns.filter(function(t){return t.type==='expense'&&t.cat;}).forEach(function(t){if(catSet.indexOf(t.cat)<0)catSet.push(t.cat);});
  catSet.sort(function(a,b){return a==='All'?-1:a.localeCompare(b);});
  var txns=p.allTxns.filter(function(t){return t.type!=='balance';});
  if(spendFilter!=='All')txns=txns.filter(function(t){return t.cat===spendFilter;});
  var total=txns.filter(function(t){return t.type==='expense';}).reduce(function(s,t){return s+Math.abs(t.amount);},0);

  var html='<div class="chips">';
  catSet.slice(0,14).forEach(function(c){html+='<div class="chip'+(c===spendFilter?' active':'')+'" onclick="setSF(\''+esc(c)+'\')">'+c+'</div>';});
  html+='</div>';
  html+='<div class="hero" style="padding:14px 16px"><div class="hglow neg"></div><div class="hi">'
    +'<div class="hmlbl">'+(spendFilter==='All'?'Total Spent':spendFilter)+'</div>'
    +'<div class="hamt neg" style="font-size:26px">'+peso(total)+'</div></div></div>';
  html+=buildTGs(txns);
  html+='<div class="ts">'+(lastUp?'Updated '+lastUp.toLocaleTimeString('en-PH',{hour:'2-digit',minute:'2-digit'}):'')+'</div>';
  el.innerHTML=html;
}
function setSF(cat){spendFilter=cat;renderSpend();document.getElementById('p2').scrollTop=0;}

function buildTGs(txns){
  if(!txns.length)return '<div class="tempty">No transactions</div>';
  var byDate={},keys=[];
  txns.forEach(function(t){
    var key=t.date?t.date.toLocaleDateString('en-PH',{month:'short',day:'numeric',year:'numeric'}):'--';
    if(!byDate[key]){byDate[key]={txns:[],date:t.date};keys.push(key);}
    byDate[key].txns.push(t);
  });
  return keys.map(function(dk,gi){
    var g=byDate[dk];
    var dt=g.txns.reduce(function(s,t){return s+t.amount;},0);
    return '<div class="dg"><div class="dghdr"><span class="dglbl">'+dk+'</span>'
      +'<span class="dgtot '+(dt<0?'neg':'pos')+'">'+(dt<0?'&#8722;':'+')+peso(Math.abs(dt))+'</span></div>'
      +'<div class="tlist">'
      +g.txns.map(function(t,i){
          var cls=t.type==='income'?'income':t.type==='transfer'?'transfer':'expense';
          return '<div class="trow" style="animation-delay:'+((gi*4+i)*12)+'ms">'
            +'<div class="trowl"><div class="trowname">'+(t.merchant||'--')+'</div>'
            +(t.memo?'<div class="trowmemo">'+t.memo+'</div>':'')
            +'<div class="trowcat">'+(t.cat||t.group||'--')+'</div></div>'
            +'<div class="trowr"><div class="trowamt '+cls+'">'+(t.amount<0?'&#8722;':'+')+peso(Math.abs(t.amount))+'</div>'
            +'<div class="trowvia">'+t.payment+'</div></div></div>';
        }).join('')+'</div></div>';
  }).join('');
}

// ── ACCOUNTS ─────────────────────────────────────────────────────────────
function renderAccounts(){
  var p=parsed,el=document.getElementById('ac');
  if(accDet){renderAccDet(accDet);return;}
  var html='<div class="nw"><div class="nwlbl">Net Worth</div>'
    +'<div class="nwamt '+(p.netWorth>=0?'pos':'neg')+'">'+(p.netWorth<0?'&#8722;':'')+peso(Math.abs(p.netWorth))+'</div>'
    +'<div class="nwsub">Latest balance across all accounts</div></div>'
    +'<div class="lbl">Accounts</div><div class="accs">';
  ACCOUNTS.forEach(function(acc){
    var bal=p.accBals[acc]||0,txns=p.txnsByAcc[acc]||[];
    var bc=bal>0?'pos':bal<0?'neg':'zero';
    html+='<div class="accrow" onclick="openAccDet(\''+acc+'\')">'
      +'<div class="accl"><div class="accname">'+acc+'</div><div class="accmeta">'+txns.length+' txn'+(txns.length!==1?'s':'')+' this month</div></div>'
      +'<div class="accr"><div class="accbal '+bc+'">'+(bal<0?'&#8722;':'')+peso(Math.abs(bal))+'</div><div class="accchev">&#8250;</div></div></div>';
  });
  html+='</div><div class="ts">'+(lastUp?'Updated '+lastUp.toLocaleTimeString('en-PH',{hour:'2-digit',minute:'2-digit'}):'')+'</div>';
  el.innerHTML=html;
}
function openAccDet(acc){accDet={account:acc,filter:'all'};renderAccDet(accDet);haptic();}
function renderAccDet(mode){
  var p=parsed,el=document.getElementById('ac');
  var acc=mode.account,flt=mode.filter;
  var bal=p.accBals[acc]||0;
  var all=p.txnsByAcc[acc]||[];
  var txns=flt==='income'?all.filter(function(t){return t.type==='income';}):flt==='expense'?all.filter(function(t){return t.type==='expense';}):all;
  el.innerHTML='<div class="back" onclick="closeAccDet()"><span style="font-size:18px">&#8249;</span>'+acc+'</div>'
    +'<div class="nw" style="border-radius:14px;padding:14px 16px"><div class="nwlbl">Balance</div>'
    +'<div class="nwamt '+(bal>=0?'pos':'neg')+'" style="font-size:24px">'+(bal<0?'&#8722;':'')+peso(Math.abs(bal))+'</div></div>'
    +'<div class="afbar">'
    +'<div class="afc'+(flt==='all'?' active':'')+'" onclick="setAF(\''+acc+'\',\'all\')">All</div>'
    +'<div class="afc'+(flt==='income'?' active':'')+'" onclick="setAF(\''+acc+'\',\'income\')">Income</div>'
    +'<div class="afc'+(flt==='expense'?' active':'')+'" onclick="setAF(\''+acc+'\',\'expense\')">Expenses</div>'
    +'</div>'+buildTGs(txns)
    +'<div class="ts">'+(lastUp?'Updated '+lastUp.toLocaleTimeString('en-PH',{hour:'2-digit',minute:'2-digit'}):'')+'</div>';
}
function setAF(acc,flt){accDet={account:acc,filter:flt};renderAccDet(accDet);}
function closeAccDet(){accDet=null;renderAccounts();}

// ── MORE ──────────────────────────────────────────────────────────────────
function renderMore(){
  var p=parsed,el=document.getElementById('mc');
  var sinking=p.categories.filter(function(c){return c.group==='Sinking';});
  var goals=p.categories.filter(function(c){return c.group==='Goals';});
  var html='';

  // Budget vs Activity per category
  html+='<div class="lbl">Budget vs Activity</div><div class="more">';
  var byGrp2={};
  p.categories.filter(function(c){return c.group!=='Income';}).forEach(function(c){if(!byGrp2[c.group])byGrp2[c.group]=[];byGrp2[c.group].push(c);});
  var gkeys=GORDER.filter(function(g){return byGrp2[g];}).concat(Object.keys(byGrp2).filter(function(g){return GORDER.indexOf(g)<0;}));
  gkeys.forEach(function(gname){
    var items=byGrp2[gname];if(!items||!items.length)return;
    var gTA=items.reduce(function(s,i){return s+i.totalAssigned;},0);
    var gAct=items.reduce(function(s,i){return s+i.actAmt;},0);
    html+='<div style="padding:10px 14px 8px;border-bottom:1px solid var(--border)">'
      +'<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:7px">'
      +'<span style="font-family:\'Syne\',sans-serif;font-size:12px;font-weight:700;color:var(--text2)">'+gname+'</span>'
      +'<span style="font-family:\'DM Mono\',monospace;font-size:10px;color:var(--muted)">'+sh(gAct)+' / '+sh(gTA)+'</span></div>';
    items.forEach(function(c){
      html+='<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">'
        +'<div style="font-size:12px;flex:1;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">'+c.cat+'</div>'
        +'<div style="flex-shrink:0;width:80px;height:4px;background:var(--surface3);border-radius:2px;overflow:hidden;position:relative">'
        +'<div style="position:absolute;top:0;left:0;height:100%;width:100%;background:rgba(42,157,159,.18);border-radius:2px"></div>'
        +'<div style="position:absolute;top:0;left:0;height:100%;width:'+Math.round(c.pct)+'%;border-radius:2px;background:'+(c.status==='over'?'var(--expense)':c.status==='warn'?'var(--warn)':'var(--accent)')+'"></div>'
        +'</div>'
        +'<div style="font-family:\'DM Mono\',monospace;font-size:10px;width:50px;text-align:right;font-variant-numeric:tabular-nums;color:'+(c.available<0?'var(--expense)':c.available===0?'var(--muted)':'var(--income)')+'">'+(c.available<0?'&#8722;':'')+sh(Math.abs(c.available))+'</div>'
        +'</div>';
    });
    html+='</div>';
  });
  html+='</div>';

  html+='<div class="lbl">Top Spends</div><div class="more">';
  if(p.top5.length){
    p.top5.forEach(function(t,i){
      html+='<div class="t5r"><div class="t5rank">'+(i+1)+'</div><div class="t5l">'
        +'<div class="t5n">'+(t.merchant||'--')+'</div>'
        +'<div class="t5c">'+(t.memo||t.cat)+'</div></div>'
        +'<div class="t5a">&#8722;'+peso(t.amount)+'</div></div>';
    });
  }else html+='<div style="padding:20px;text-align:center;font-size:12px;color:var(--muted)">No transactions</div>';
  html+='</div>';

  html+='<div class="lbl">By Merchant</div><div class="more">';
  if(p.merch.length){
    p.merch.forEach(function(m){
      html+='<div class="mr2"><div class="mr2n">'+m.name+'</div><div class="mr2r">'
        +'<div class="mr2a">&#8722;'+peso(m.total)+'</div>'
        +'<div class="mr2c">'+m.count+' txn'+(m.count!==1?'s':'')+'</div></div></div>';
    });
  }else html+='<div style="padding:20px;text-align:center;font-size:12px;color:var(--muted)">No data</div>';
  html+='</div>';

  if(sinking.length){
    html+='<div class="lbl">Sinking Funds</div><div class="more">';
    sinking.forEach(function(c){
      var pct=c.totalAssigned>0?Math.min((c.available/c.totalAssigned)*100,100):0;
      html+='<div class="mrow"><div class="mrowl"><div class="mrowname">'+c.cat+'</div>'
        +'<div class="mrowsub">'+peso(c.available)+' saved &middot; '+peso(c.totalAssigned)+'/mo</div></div>'
        +'<div class="mrowr"><div class="mamount '+(c.available<0?'neg':'pos')+'">'+sh(c.available)+'</div>'
        +'<div class="gbar"><div class="gfill'+(pct>=100?' full':'')+'" style="width:'+Math.max(0,pct)+'%"></div></div>'
        +'</div></div>';
    });
    html+='</div>';
  }
  if(goals.length){
    html+='<div class="lbl">Goals</div><div class="more">';
    goals.forEach(function(c){
      var pct=c.goal>0?Math.min((c.available/c.goal)*100,100):0;
      var left=c.goal>0&&c.available<c.goal?Math.ceil((c.goal-c.available)/(c.goal/12)):0;
      html+='<div class="mrow"><div class="mrowl"><div class="mrowname">'+c.cat+'</div>'
        +'<div class="mrowsub">'+peso(c.available)+' of '+peso(c.goal)+(left>0?' &middot; ~'+left+'mo':' &middot; funded')+'</div></div>'
        +'<div class="mrowr"><div class="mamount '+(pct>=100?'pos':'n')+'">'+Math.round(pct)+'%</div>'
        +'<div class="gbar"><div class="gfill'+(pct>=100?' full':'')+'" style="width:'+Math.max(0,pct)+'%"></div></div>'
        +'</div></div>';
    });
    html+='</div>';
  }
  html+='<div class="ts">'+(lastUp?'Updated '+lastUp.toLocaleTimeString('en-PH',{hour:'2-digit',minute:'2-digit'}):'')+'</div>';
  el.innerHTML=html;
}

// ── DEBUG ─────────────────────────────────────────────────────────────────
function toggleDbg(){
  dbgOpen=!dbgOpen;
  document.getElementById('dbgpanel').classList.toggle('hidden',!dbgOpen);
  document.getElementById('dbgbtn').classList.toggle('on',dbgOpen);
  if(dbgOpen&&parsed)renderDbg();
}
function switchDbgTab(i){
  dbgTab=i;
  document.querySelectorAll('.dbgtab').forEach(function(t,j){t.classList.toggle('active',j===i);});
  if(parsed)renderDbg();
}
function renderDbg(){
  var el=document.getElementById('dbgbody');
  if(!rawB){el.innerHTML='<div class="dbgempty">No data loaded yet.</div>';return;}
  var dbg=parsed._dbg,p=parsed;
  if(dbgTab===0){
    el.innerHTML='<div class="dbgsec"><div class="dbgst">Parser Health</div>'
      +[['Budget header?',dbg.bHdr,'bool'],['Activity header?',dbg.aHdr,'bool'],['Snapshot header?',dbg.sHdr,'bool'],
        ['Raw Budget rows',dbg.rawB,'num'],['Raw Activity rows',dbg.rawA,'num'],
        ['Budget this month',dbg.bMo,'w0'],['Activity this month',dbg.aMo,'w0'],
        ['Categories',dbg.cats,'w0'],['Expense txns',dbg.expCt,'num'],
        ['Income txns',dbg.incCt,'num'],['Balance rows',dbg.balCt,'w0']]
      .map(function(c){var cls=c[2]==='bool'?(c[1]?'ok':'bad'):c[2]==='w0'?(c[1]===0?'bad':'ok'):'';
        return '<div class="dbgrow"><span class="dbgk">'+c[0]+'</span><span class="dbgv '+cls+'">'+(c[1]===true?'yes':c[1]===false?'no':String(c[1]))+'</span></div>';}).join('')
      +'</div><div class="dbgsec"><div class="dbgst">Key Values</div><div class="dbggrid">'
      +[['Left to Assign',peso(p.readyToAssign),'Snapshot col G'],
        ['Total Income',peso(p.totalInc),'Activity Income txns'],
        ['Total Expense',peso(p.totalExp),'Activity Expense txns'],
        ['Total Assigned',peso(p.totalAssignedAll),'Budget col M sum'],
        ['Net Worth',peso(p.netWorth),'Latest Balance rows'],
        ['Assigned This Mo',peso(p.assignedThisMonth),'Snapshot col D']]
      .map(function(x){return '<div class="dbgstat"><div class="dbgslbl">'+x[0]+'</div><div class="dbgsval">'+x[1]+'</div><div style="font-size:9px;color:var(--muted);margin-top:1px">'+x[2]+'</div></div>';}).join('')
      +'</div></div>'
      +'<div class="dbgsec"><div class="dbgst">Account Balances</div>'
      +ACCOUNTS.map(function(a){var b=p.accBals[a];return '<div class="dbgrow"><span class="dbgk">'+a+'</span><span class="dbgv '+(b>0?'ok':b<0?'bad':'')+'">'+(b<0?'&#8722;':'')+peso(Math.abs(b))+'</span></div>';}).join('')
      +'</div>';
  }else if(dbgTab===1){
    var s=p._bRows.slice(0,5);
    el.innerHTML='<div class="dbgsec"><div class="dbgst">Budget Column Map</div>'
      +[['5 (F)','MonthStart (date filter)'],['6 (G)','Group'],['7 (H)','Category'],
        ['8 (I)','Monthly Goal'],['10 (K)','Assigned'],['11 (L)','Funded'],
        ['12 (M)','TotalAssigned (bar ref)'],['13 (N)','Activity'],
        ['14 (O)','Available (truth)'],['15 (P)','Overspent']]
      .map(function(x){return '<div class="dbgrow"><span class="dbgk">Col '+x[0]+'</span><span class="dbgv">'+x[1]+'</span></div>';}).join('')
      +'</div><div class="dbgsec"><div class="dbgst">First 5 Budget Rows This Month</div>'
      +(s.length===0?'<div class="dbgempty">No rows - check MonthStart parsing</div>'
        :s.map(function(row,i){var pd=parseDate(row[5]);return '<div class="dbgrow" style="flex-direction:column;gap:3px;align-items:flex-start"><span class="dbgk">Row '+(i+1)+': '+String(row[7]||'?')+' / '+String(row[6]||'?')+'</span><span class="dbgv" style="font-size:9px;text-align:left">MonthStart(5): '+String(row[5]||'--')+' &rarr; '+(pd?pd.toLocaleDateString():'FAIL')+'<br>TotalAssigned(12): '+String(row[12]||0)+' Activity(13): '+String(row[13]||0)+'<br>Available(14): '+String(row[14]||0)+'</span></div>';}).join('')
        +'<div class="dbgnote">Col 12 = TotalAssigned is the budget bar reference</div>')
      +'</div>';
  }else if(dbgTab===2){
    var s2=p._mAct.slice(0,6);
    el.innerHTML='<div class="dbgsec"><div class="dbgst">Activity Column Map</div>'
      +[['0 (A)','Date (used for month filter)'],['1 (B)','Type'],['2 (C)','Amount (neg=expense)'],
        ['3 (D)','Merchant'],['4 (E)','Payment Method'],['5 (F)','Category'],
        ['6 (G)','Group'],['7 (H)','Memo'],['11 (L)','MonthStart label (NOT used for filtering)']]
      .map(function(x){return '<div class="dbgrow"><span class="dbgk">Col '+x[0]+'</span><span class="dbgv">'+x[1]+'</span></div>';}).join('')
      +'</div><div class="dbgsec"><div class="dbgst">First 6 Activity Rows This Month</div>'
      +(s2.length===0?'<div class="dbgempty">No rows - check date parsing</div>'
        :s2.map(function(row,i){var pd=parseDate(row[0]);return '<div class="dbgrow" style="flex-direction:column;gap:3px;align-items:flex-start"><span class="dbgk">Row '+(i+1)+': '+String(row[1]||'?')+' &mdash; '+String(row[3]||'?')+'</span><span class="dbgv" style="font-size:9px;text-align:left">Date(0): '+String(row[0]||'--')+' &rarr; '+(pd?pd.toLocaleDateString():'FAIL')+'<br>Amount(2): '+String(row[2]||0)+' Payment(4): '+String(row[4]||'--')+'<br>Cat(5): '+String(row[5]||'--')+' Group(6): '+String(row[6]||'--')+'<br>Memo(7): '+String(row[7]||'--')+'</span></div>';}).join('')
        +'<div class="dbgnote">Month filter uses col 0 Date. Memo is col 7 (H).</div>')
      +'</div>';
  }else if(dbgTab===3){
    el.innerHTML='<div class="dbgsec"><div class="dbgst">Snapshot Column Map</div>'
      +[['0 (A)','MonthStart'],['1 (B)','CashStart'],['2 (C)','InflowExternal'],
        ['3 (D)','AssignedThisMonth'],['4 (E)','OutflowExternal'],['5 (F)','CashEnd'],
        ['6 (G)','ReadyToAssignEnd (hero value)']]
      .map(function(x){return '<div class="dbgrow"><span class="dbgk">Col '+x[0]+'</span><span class="dbgv">'+x[1]+'</span></div>';}).join('')
      +'</div><div class="dbgsec"><div class="dbgst">All Snapshot Rows</div>'
      +(p._sData.length===0?'<div class="dbgempty">No rows</div>'
        :p._sData.map(function(row){var dt=parseDate(row[0]);var cur=dt&&dt.getMonth()===viewMonth.getMonth()&&dt.getFullYear()===viewMonth.getFullYear();return '<div class="dbgrow" style="flex-direction:column;gap:3px;align-items:flex-start;'+(cur?'background:var(--accent-dim);':'')+'">'+'<span class="dbgk">'+String(row[0]||'?')+(cur?' (current)':'')+'</span>'+'<span class="dbgv" style="font-size:9px;text-align:left">Parsed: '+(dt?dt.toLocaleDateString():'FAIL')+' | RTA(G): <strong style="color:var(--warn)">'+String(row[6]||'--')+'</strong></span></div>';}).join('')
        +'<div class="dbgnote">Col G ReadyToAssignEnd = hero card</div>')
      +'</div>';
  }
}

// ── BOOT ──────────────────────────────────────────────────────────────────
setML();
if(!loadCache()){loadData();}else{loadData();}

</script>
</body>
</html>
